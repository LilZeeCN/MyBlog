---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="åšå®¢ - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="container mx-auto px-4 py-12">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="text-center mb-12">
      <div class="text-6xl mb-4 animate-float">ğŸ“</div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">æˆ‘çš„åšå®¢</h1>
      <p class="text-xl text-text-secondary">ç”Ÿæ´»ã€æ€è€ƒã€å­¦ä¹ ä¸é¡¹ç›®çš„è®°å½•</p>
    </section>

    <!-- æ“ä½œæ  -->
    <div class="flex justify-between items-center mb-8 max-w-4xl mx-auto">
      <!-- æœç´¢æ¡† -->
      <div class="relative flex-1 mr-4">
        <input
          type="text"
          id="search-input"
          placeholder="æœç´¢å†…å®¹..."
          class="w-full px-4 py-2 pl-10 rounded-lg border border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-300"
        />
        <svg class="w-5 h-5 absolute left-3 top-2.5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>

      <!-- å¿«é€Ÿæ·»åŠ æŒ‰é’® -->
      <div class="flex gap-2">
        <a href="/life/new" class="auth-only px-4 py-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-smooth text-sm" title="ç”Ÿæ´»">
          ğŸŒ± ç”Ÿæ´»
        </a>
        <a href="/philosophy/new" class="auth-only px-4 py-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition-smooth text-sm" title="å“²å­¦">
          ğŸ§  å“²å­¦
        </a>
        <a href="/rants/new" class="auth-only px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-smooth text-sm" title="åæ§½">
          ğŸ’¢ åæ§½
        </a>
        <a href="/learning/new" class="auth-only px-4 py-2 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200 transition-smooth text-sm" title="å­¦ä¹ ">
          ğŸ“š å­¦ä¹ 
        </a>
        <a href="/projects/new" class="auth-only px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-smooth text-sm" title="é¡¹ç›®">
          ğŸ’» é¡¹ç›®
        </a>
      </div>
    </div>

    <!-- ç±»å‹ç­›é€‰ -->
    <div class="flex flex-wrap gap-2 mb-8 justify-center">
      <button class="type-filter active px-4 py-2 rounded-full text-sm transition-smooth" data-type="all">
        å…¨éƒ¨
      </button>
      <button class="type-filter px-4 py-2 rounded-full text-sm transition-smooth" data-type="life">
        ğŸŒ± ç”Ÿæ´»
      </button>
      <button class="type-filter px-4 py-2 rounded-full text-sm transition-smooth" data-type="philosophy">
        ğŸ§  å“²å­¦
      </button>
      <button class="type-filter px-4 py-2 rounded-full text-sm transition-smooth" data-type="rants">
        ğŸ’¢ åæ§½
      </button>
      <button class="type-filter px-4 py-2 rounded-full text-sm transition-smooth" data-type="learning">
        ğŸ“š å­¦ä¹ 
      </button>
      <button class="type-filter px-4 py-2 rounded-full text-sm transition-smooth" data-type="projects">
        ğŸ’» é¡¹ç›®
      </button>
    </div>

    <!-- å†…å®¹åˆ—è¡¨ -->
    <section id="content-container" class="max-w-4xl mx-auto space-y-8">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="loading" class="text-center py-12">
        <div class="animate-pulse">æ­£åœ¨åŠ è½½å†…å®¹...</div>
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div id="empty-state" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <h2 class="text-2xl font-bold mb-4">è¿˜æ²¡æœ‰å†…å®¹</h2>
        <p class="text-text-muted mb-6">å¼€å§‹è®°å½•ä½ çš„ç”Ÿæ´»ã€æ€è€ƒå’Œå­¦ä¹ å§ï¼</p>
      </div>

      <!-- å†…å®¹åˆ—è¡¨ -->
      <div id="content-list" class="space-y-8">
        <!-- å†…å®¹å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </section>
  </div>

  <script>
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // è·å–ç±»å‹å›¾æ ‡
    function getTypeIcon(type: string): string {
      const icons: Record<string, string> = {
        'life': 'ğŸŒ±',
        'philosophy': 'ğŸ§ ',
        'rants': 'ğŸ’¢',
        'learning': 'ğŸ“š',
        'projects': 'ğŸ’»'
      };
      return icons[type] || 'ğŸ“';
    }

    // è·å–ç±»å‹é¢œè‰²
    function getTypeColor(type: string): string {
      const colors: Record<string, string> = {
        'life': 'bg-green-100 text-green-600',
        'philosophy': 'bg-purple-100 text-purple-600',
        'rants': 'bg-red-100 text-red-600',
        'learning': 'bg-yellow-100 text-yellow-600',
        'projects': 'bg-blue-100 text-blue-600'
      };
      return colors[type] || 'bg-gray-100 text-gray-600';
    }

    // è·å–è¯¦æƒ…é¡µè·¯å¾„
    function getDetailPath(item: any): string {
      const paths: Record<string, string> = {
        'life': '/life',
        'philosophy': '/philosophy',
        'rants': '/rants',
        'learning': '/learning',
        'projects': '/projects'
      };
      const basePath = paths[item.contentType] || '';
      return `${basePath}/${item.slug}`;
    }

    // æ¸²æŸ“å†…å®¹å¡ç‰‡
    function renderContentCard(item: any): string {
      const typeIcon = getTypeIcon(item.contentType);
      const typeColor = getTypeColor(item.contentType);
      const detailPath = getDetailPath(item);

      // æ ¹æ®ä¸åŒç±»å‹æ¸²æŸ“ä¸åŒæ ·å¼
      if (item.contentType === 'life') {
        return `
          <article class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up">
            <div class="flex items-start gap-4">
              <span class="text-4xl">${typeIcon}</span>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 ${typeColor} rounded text-xs font-medium">${item.typeName}</span>
                  <span class="text-sm text-text-muted">${formatDate(item.date || item.createdAt)}</span>
                  ${item.mood ? `<span class="text-sm">${item.mood}</span>` : ''}
                </div>
                <h3 class="text-xl font-bold mb-2">
                  <a href="${detailPath}" class="hover:text-primary-400 transition-colors">${item.title}</a>
                </h3>
                <p class="text-text-muted line-clamp-2">${item.content}</p>
              </div>
            </div>
          </article>
        `;
      }

      if (item.contentType === 'philosophy') {
        return `
          <article class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up">
            <div class="flex items-start gap-4">
              <span class="text-4xl">${typeIcon}</span>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 ${typeColor} rounded text-xs font-medium">${item.typeName}</span>
                  <span class="text-sm text-text-muted">${formatDate(item.createdAt)}</span>
                </div>
                <blockquote class="text-lg italic text-primary-400 mb-2">"${item.quote}"</blockquote>
                <p class="text-sm text-text-muted">â€” ${item.author}</p>
                <p class="text-text-muted mt-2 line-clamp-2">${item.content}</p>
              </div>
            </div>
          </article>
        `;
      }

      if (item.contentType === 'rants') {
        return `
          <article class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up">
            <div class="flex items-start gap-4">
              <span class="text-4xl">${typeIcon}</span>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 ${typeColor} rounded text-xs font-medium">${item.typeName}</span>
                  <span class="text-sm text-text-muted">${formatDate(item.createdAt)}</span>
                  <span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-medium">
                    æ„¤æ€’å€¼: ${item.angerLevel}/10
                  </span>
                </div>
                <h3 class="text-xl font-bold mb-2">
                  <a href="${detailPath}" class="hover:text-primary-400 transition-colors">${item.title}</a>
                </h3>
                <p class="text-text-muted line-clamp-2">${item.content}</p>
              </div>
            </div>
          </article>
        `;
      }

      if (item.contentType === 'learning') {
        return `
          <article class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up">
            <div class="flex items-start gap-4">
              <span class="text-4xl">${typeIcon}</span>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 ${typeColor} rounded text-xs font-medium">${item.typeName}</span>
                  <span class="text-sm text-text-muted">${formatDate(item.createdAt)}</span>
                  <span class="px-2 py-1 rounded text-xs font-medium ${getStatusColor(item.status)}">${item.status}</span>
                </div>
                <h3 class="text-xl font-bold mb-2">
                  <a href="${detailPath}" class="hover:text-primary-400 transition-colors">${item.title}</a>
                </h3>
                <p class="text-text-muted mb-2">${item.description || ''}</p>
                <div class="flex items-center gap-4 text-sm">
                  <span class="text-text-muted">è¿›åº¦: ${item.progress}%</span>
                  <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div class="bg-primary-400 h-2 rounded-full" style="width: ${item.progress}%"></div>
                  </div>
                </div>
              </div>
            </div>
          </article>
        `;
      }

      if (item.contentType === 'projects') {
        return `
          <article class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up">
            <div class="flex items-start gap-4">
              <span class="text-4xl">${item.coverEmoji || 'ğŸ’»'}</span>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-1 ${typeColor} rounded text-xs font-medium">${item.typeName}</span>
                  <span class="text-sm text-text-muted">${formatDate(item.createdAt)}</span>
                  <span class="px-2 py-1 rounded text-xs font-medium ${getProjectStatusColor(item.status)}">${item.status}</span>
                </div>
                <h3 class="text-xl font-bold mb-2">
                  <a href="${detailPath}" class="hover:text-primary-400 transition-colors">${item.title}</a>
                </h3>
                <p class="text-text-muted mb-2">${item.description}</p>
                ${item.technologies && item.technologies.length > 0 ? `
                  <div class="flex flex-wrap gap-2">
                    ${item.technologies.map((tech: string) => `<span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs">${tech}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          </article>
        `;
      }

      return '';
    }

    function getStatusColor(status: string): string {
      const colors: Record<string, string> = {
        'è®¡åˆ’ä¸­': 'bg-gray-100 text-gray-600',
        'è¿›è¡Œä¸­': 'bg-blue-100 text-blue-600',
        'å·²å®Œæˆ': 'bg-green-100 text-green-600',
        'æš‚åœ': 'bg-yellow-100 text-yellow-600'
      };
      return colors[status] || 'bg-gray-100 text-gray-600';
    }

    function getProjectStatusColor(status: string): string {
      const colors: Record<string, string> = {
        'Concept': 'bg-purple-100 text-purple-600',
        'WIP': 'bg-blue-100 text-blue-600',
        'Beta': 'bg-yellow-100 text-yellow-600',
        'Stable': 'bg-green-100 text-green-600',
        'Archived': 'bg-gray-100 text-gray-600'
      };
      return colors[status] || 'bg-gray-100 text-gray-600';
    }

    // åŠ è½½å¹¶æ˜¾ç¤ºå†…å®¹
    async function loadContent(type: string = 'all', searchQuery: string = ''): Promise<void> {
      const loading = document.getElementById('loading');
      const emptyState = document.getElementById('empty-state');
      const contentList = document.getElementById('content-list');

      if (!loading || !emptyState || !contentList) return;

      try {
        // è°ƒç”¨èšåˆ API
        const params = new URLSearchParams();
        if (type !== 'all') params.append('type', type);
        if (searchQuery) params.append('search', searchQuery);

        const response = await fetch(`/api/posts?${params}`);
        const content = await response.json();

        loading.classList.add('hidden');

        if (!content || content.length === 0) {
          contentList.classList.add('hidden');
          emptyState.classList.remove('hidden');
        } else {
          emptyState.classList.add('hidden');
          contentList.classList.remove('hidden');
          contentList.innerHTML = content.map(renderContentCard).join('');
        }
      } catch (error: any) {
        loading.innerHTML = `<p class="text-red-500">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    }

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
      // åŠ è½½å†…å®¹
      loadContent();

      // ç±»å‹ç­›é€‰
      document.querySelectorAll('.type-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.querySelectorAll('.type-filter').forEach(b => {
            b.classList.remove('active', 'bg-primary-300', 'text-white');
            b.classList.add('bg-primary-50', 'text-text-muted');
          });
          btn.classList.add('active', 'bg-primary-300', 'text-white');
          btn.classList.remove('bg-primary-50', 'text-text-muted');

          // åŠ è½½å¯¹åº”ç±»å‹çš„å†…å®¹
          const type = (btn as HTMLElement).dataset.type || 'all';
          const searchInput = document.getElementById('search-input') as HTMLInputElement;
          const searchQuery = searchInput?.value || '';
          loadContent(type, searchQuery);
        });
      });

      // åˆå§‹åŒ–æ¿€æ´»çŠ¶æ€
      const activeBtn = document.querySelector('.type-filter.active');
      if (activeBtn) {
        activeBtn.classList.add('bg-primary-300', 'text-white');
      }

      // æœç´¢åŠŸèƒ½
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      let searchTimeout: ReturnType<typeof setTimeout>;
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const query = searchInput.value.trim();
            const activeType = (document.querySelector('.type-filter.active') as HTMLElement)?.dataset.type || 'all';
            loadContent(activeType, query);
          }, 300);
        });
      }
    });
  </script>
</Layout>
