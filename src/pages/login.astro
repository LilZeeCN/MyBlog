---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ç®¡ç†å‘˜ç™»å½• - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="min-h-[80vh] flex items-center justify-center px-4">
    <div class="w-full max-w-md">
      <!-- ç™»å½•å¡ç‰‡ -->
      <div class="glass-effect rounded-2xl p-8 shadow-lg">
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">ğŸ”</div>
          <h1 class="text-3xl font-bold mb-2">ç®¡ç†å‘˜ç™»å½•</h1>
          <p class="text-text-muted">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </p>
        </div>

        <form id="login-form" class="space-y-6">
          <div>
            <label for="password" class="block text-sm font-medium mb-2">å¯†ç </label>
            <input
              type="password"
              id="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-3 rounded-lg border border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-300 transition-smooth"
              placeholder="è¯·è¾“å…¥å¯†ç "
            />
          </div>

          <div id="error-message" class="hidden p-3 bg-red-100 text-red-700 rounded-lg text-sm">
          </div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            ç™»å½•
          </button>

          <div class="text-center">
            <a href="/" class="text-sm text-text-muted hover:text-primary-400 transition-smooth">
              è¿”å›é¦–é¡µ
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('login-form') as HTMLFormElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;

    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/check');
        const data = await response.json();
        if (data.authenticated) {
          // å·²ç™»å½•ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
          window.location.href = '/';
        }
      } catch (error) {
        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ˜¾ç¤ºç™»å½•é¡µé¢
      }
    }

    checkAuth();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const password = passwordInput.value.trim();
      if (!password) {
        showError('è¯·è¾“å…¥å¯†ç ');
        return;
      }

      // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      submitBtn.disabled = true;
      submitBtn.textContent = 'ç™»å½•ä¸­...';
      errorMessage.classList.add('hidden');

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // ç™»å½•æˆåŠŸ
          submitBtn.textContent = 'ç™»å½•æˆåŠŸï¼';
          setTimeout(() => {
            window.location.href = '/';
          }, 500);
        } else {
          // ç™»å½•å¤±è´¥
          showError(data.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ç™»å½•';
          passwordInput.value = '';
          passwordInput.focus();
        }
      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»å½•';
      }
    });

    function showError(message: string) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }
  </script>
</Layout>
