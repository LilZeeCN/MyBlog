---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="å“²å­¦æ€è€ƒ - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="container mx-auto px-4 py-12">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="text-center mb-12">
      <div class="text-6xl mb-4 animate-float">ğŸ§ </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4 font-serif">å“²å­¦æ€è€ƒ</h1>
      <p class="text-xl text-text-secondary font-serif">æ·±åº¦æ€è€ƒä¸æ™ºæ…§åˆ†äº«</p>
      <a href="/philosophy/new" class="auth-only inline-block mt-6 px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth font-medium">
        ğŸ“ è®°å½•æ€è€ƒ
      </a>
    </section>

    <!-- å“²å­¦æ€è€ƒåˆ—è¡¨ -->
    <section id="thoughts-list" class="max-w-4xl mx-auto space-y-8">
      <div class="text-center py-12">
        <div class="animate-pulse">æ­£åœ¨åŠ è½½...</div>
      </div>
    </section>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ’­</div>
      <p class="text-xl text-text-muted mb-6">è¿˜æ²¡æœ‰å“²å­¦æ€è€ƒï¼Œå¼€å§‹è®°å½•ç¬¬ä¸€ä¸ªå§</p>
      <a href="/philosophy/new" class="auth-only inline-block px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth">
        è®°å½•æ€è€ƒ
      </a>
    </div>
  </div>

  <script>
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // åŠ è½½å¹¶æ˜¾ç¤ºæ€è€ƒ
    async function loadThoughts(): Promise<void> {
      const container = document.getElementById('thoughts-list');
      const emptyState = document.getElementById('empty-state');

      if (!container || !emptyState) return;

      try {
        const response = await fetch('/api/philosophy');
        if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
        const thoughts = await response.json();

        container.innerHTML = '';

        if (!thoughts || thoughts.length === 0) {
          container.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        container.classList.remove('hidden');

        thoughts.forEach((thought: any, index: number) => {
          const article = document.createElement('article');
          article.className = 'glass-effect rounded-2xl p-8 shadow-md hover:shadow-lg transition-smooth animate-slide-up';
          article.style.animationDelay = `${index * 0.1}s`;

          article.innerHTML = `
            <div class="flex items-center gap-4 mb-4">
              <span class="text-4xl">ğŸ’­</span>
              <div>
                <div class="text-sm text-primary-400">${thought.category || 'æ€è€ƒ'}</div>
                <div class="text-sm text-text-muted">${formatDate(thought.createdAt)}</div>
                ${thought.author ? `<div class="text-sm text-text-muted">â€”â€” ${thought.author}</div>` : ''}
              </div>
            </div>
            <blockquote class="text-2xl font-serif font-bold text-primary-400 mb-6 leading-relaxed border-l-4 border-primary-300 pl-6">
              "${thought.quote}"
            </blockquote>
            <p class="text-text-secondary leading-relaxed mb-4">
              ${thought.content}
            </p>
            ${thought.tags?.length > 0 ? `
              <div class="flex flex-wrap gap-2 mb-4">
                ${thought.tags.map((tag: string) => `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">${tag}</span>`).join('')}
              </div>
            ` : ''}
            <div class="flex gap-4 border-t pt-4">
              <a href="/philosophy/${thought.slug}" class="text-primary-400 hover:text-primary-500 transition-smooth">æŸ¥çœ‹è¯¦æƒ…</a>
              <a href="/philosophy/${thought.slug}/edit" class="auth-only text-blue-500 hover:text-blue-600 transition-smooth">ç¼–è¾‘</a>
              <button class="auth-only delete-btn text-red-500 hover:text-red-600 transition-smooth" data-id="${thought.id}">åˆ é™¤</button>
            </div>
          `;

          container.appendChild(article);
        });

        // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).getAttribute('data-id')!;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ€è€ƒå—ï¼Ÿ')) {
              try {
                const response = await fetch(`/api/philosophy/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
                loadThoughts();
              } catch (error: any) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
              }
            }
          });
        });
      } catch (error: any) {
        container.innerHTML = `<p class="text-red-500 text-center py-12">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadThoughts();
    });
  </script>

  <style>
    blockquote {
      position: relative;
    }
  </style>
</Layout>
