---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="å­¦ä¹ è¿›å±• - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="container mx-auto px-4 py-12">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="text-center mb-12">
      <div class="text-6xl mb-4 animate-float">ğŸ“š</div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">å­¦ä¹ è¿›å±•</h1>
      <p class="text-xl text-text-secondary">æŒç»­å­¦ä¹ ï¼Œä¸æ–­æˆé•¿</p>
      <a href="/learning/new" class="auth-only inline-block mt-6 px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth font-medium">
        ğŸ“š æ·»åŠ å­¦ä¹ é¡¹ç›®
      </a>
    </section>

    <!-- å­¦ä¹ è¿›åº¦å¡ç‰‡ -->
    <section id="projects-list" class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="text-center py-12 col-span-full">
        <div class="animate-pulse">æ­£åœ¨åŠ è½½...</div>
      </div>
    </section>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ“š</div>
      <p class="text-xl text-text-muted mb-6">è¿˜æ²¡æœ‰å­¦ä¹ é¡¹ç›®ï¼Œå¼€å§‹æ·»åŠ ç¬¬ä¸€ä¸ªå§</p>
      <a href="/learning/new" class="auth-only inline-block px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth">
        æ·»åŠ å­¦ä¹ é¡¹ç›®
      </a>
    </div>
  </div>

  <script>
    // åŠ è½½å¹¶æ˜¾ç¤ºå­¦ä¹ é¡¹ç›®
    async function loadProjects(): Promise<void> {
      const container = document.getElementById('projects-list');
      const emptyState = document.getElementById('empty-state');

      if (!container || !emptyState) return;

      try {
        const response = await fetch('/api/learning');
        if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
        const projects = await response.json();

        container.innerHTML = '';

        if (!projects || projects.length === 0) {
          container.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        container.classList.remove('hidden');

        projects.forEach((project: any, index: number) => {
          const status = project.status || 'è¿›è¡Œä¸­';
          const progress = project.progress || 0;

          let statusClass = 'bg-green-100 text-green-600';
          let progressGradient = 'from-primary-300 to-primary-400';
          let opacity = '';

          if (status === 'å·²å®Œæˆ') {
            statusClass = 'bg-functional-success text-white';
            progressGradient = 'from-functional-success to-green-400';
          } else if (status === 'è®¡åˆ’ä¸­') {
            statusClass = 'bg-yellow-100 text-yellow-600';
          } else if (status === 'å·²æš‚åœ') {
            statusClass = 'bg-gray-200 text-gray-600';
            progressGradient = 'from-gray-300 to-gray-400';
            opacity = 'opacity-70';
          }

          const card = document.createElement('div');
          card.className = `glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth animate-slide-up ${opacity}`;
          card.style.animationDelay = `${index * 0.1}s`;

          const resourcesHtml = project.resources?.length > 0 ? `
            <div class="space-y-2 mb-4">
              <div class="text-sm font-medium text-text-secondary">å­¦ä¹ èµ„æº:</div>
              ${project.resources.slice(0, 2).map((resource: string) => `
                <a href="${resource}" target="_blank" class="flex items-center gap-2 text-sm text-primary-400 hover:text-primary-300 transition-smooth truncate">
                  <span>ğŸ”—</span>
                  <span class="truncate">${resource}</span>
                </a>
              `).join('')}
              ${project.resources.length > 2 ? `<div class="text-xs text-text-muted">+${project.resources.length - 2} æ›´å¤š</div>` : ''}
            </div>
          ` : '';

          const dateInfo = [];
          if (project.startDate) {
            dateInfo.push(`å¼€å§‹: ${project.startDate}`);
          }
          if (project.endDate) {
            dateInfo.push(`${status === 'å·²å®Œæˆ' ? 'å®Œæˆ' : 'é¢„è®¡'}: ${project.endDate}`);
          }
          const dateHtml = dateInfo.length > 0 ? `<div class="text-xs text-text-muted mb-4">${dateInfo.join(' | ')}</div>` : '';

          card.innerHTML = `
            <div class="flex items-center justify-between mb-4">
              <span class="text-4xl">ğŸ“–</span>
              <span class="px-3 py-1 ${statusClass} rounded-full text-sm font-medium">${status}</span>
            </div>
            <a href="/learning/${project.slug}" class="text-xl font-bold mb-2 hover:text-primary-400 transition-smooth block">${project.title}</a>
            <p class="text-text-muted text-sm mb-4 line-clamp-2">${project.description}</p>

            <!-- è¿›åº¦æ¡ -->
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-1">
                <span>è¿›åº¦</span>
                <span class="font-bold">${progress}%</span>
              </div>
              <div class="h-3 bg-primary-100 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r ${progressGradient} rounded-full animate-fade-in" style="width: ${progress}%"></div>
              </div>
            </div>

            ${resourcesHtml}
            ${dateHtml}

            <div class="flex gap-3 border-t pt-4">
              <a href="/learning/${project.slug}" class="text-primary-400 hover:text-primary-500 transition-smooth text-sm">æŸ¥çœ‹è¯¦æƒ…</a>
              <a href="/learning/${project.slug}/edit" class="auth-only text-blue-500 hover:text-blue-600 transition-smooth text-sm">ç¼–è¾‘</a>
              <button class="auth-only delete-btn text-red-500 hover:text-red-600 transition-smooth text-sm" data-id="${project.id}">åˆ é™¤</button>
            </div>
          `;

          container.appendChild(card);
        });

        // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).getAttribute('data-id')!;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ä¹ é¡¹ç›®å—ï¼Ÿ')) {
              try {
                const response = await fetch(`/api/learning/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
                loadProjects();
              } catch (error: any) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
              }
            }
          });
        });
      } catch (error: any) {
        container.innerHTML = `<p class="text-red-500 text-center py-12 col-span-full">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadProjects();
    });
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
