---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="ç”Ÿæ´»åˆ†äº« - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="container mx-auto px-4 py-12">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="text-center mb-12">
      <div class="text-6xl mb-4 animate-float">ğŸŒ±</div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">ç”Ÿæ´»åˆ†äº«</h1>
      <p class="text-xl text-text-secondary">è®°å½•ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´</p>
    </section>

    <!-- æ“ä½œæ  -->
    <div class="flex justify-end items-center mb-8 max-w-4xl mx-auto">
      <a href="/life/new" class="auth-only px-6 py-2 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        è®°å½•ç”Ÿæ´»
      </a>
    </div>

    <!-- æ—¶é—´è½´å±•ç¤ºåŒº -->
    <section class="max-w-4xl mx-auto">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="loading" class="text-center py-12">
        <div class="animate-pulse">æ­£åœ¨åŠ è½½...</div>
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div id="empty-state" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <h2 class="text-2xl font-bold mb-4">è¿˜æ²¡æœ‰ç”Ÿæ´»è®°å½•</h2>
        <p class="text-text-muted mb-6">å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ä¸ªç”Ÿæ´»ç¬é—´å§ï¼</p>
        <a href="/life/new" class="auth-only inline-block px-6 py-3 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth">
          è®°å½•ç¬¬ä¸€ä¸ªç¬é—´
        </a>
      </div>

      <!-- æ—¶é—´è½´å†…å®¹ -->
      <div id="timeline-container" class="hidden relative">
        <!-- æ—¶é—´è½´çº¿ -->
        <div class="absolute left-4 md:left-1/2 top-0 bottom-0 w-0.5 bg-primary-200 transform md:-translate-x-1/2"></div>

        <!-- ç”Ÿæ´»ç¬é—´å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        <div id="moments-list" class="space-y-8">
        </div>
      </div>
    </section>
  </div>

  <script>
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // åˆ é™¤ç¬é—´
    (window as any).deleteMoment = async function(momentId: string, momentTitle: string): Promise<void> {
      if (confirm('ç¡®å®šè¦åˆ é™¤ã€Š' + momentTitle + 'ã€‹å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
        try {
          const response = await fetch(`/api/life/${momentId}`, { method: 'DELETE' });
          if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
          alert('å·²åˆ é™¤');
          loadMoments();
        } catch (error: any) {
          alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
      }
    };

    // æ¸²æŸ“ç¬é—´å¡ç‰‡
    function renderMoment(moment: any, index: number): string {
      const isLeft = index % 2 === 0;
      const delay = `style="animation-delay: ${index * 0.1}s"`;

      return `
        <div class="relative flex items-center ${!isLeft ? 'flex-row-reverse' : ''} animate-slide-up" ${delay}>
          <div class="flex-1 md:w-1/2 ${isLeft ? 'md:pr-8 md:text-right' : 'md:pl-8'}">
            <div class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth">
              <div class="text-sm text-primary-400 mb-2">${moment.date || formatDate(moment.createdAt)}</div>
              <h3 class="text-xl font-bold mb-2">${moment.title}</h3>
              <p class="text-text-muted mb-4">${moment.content}</p>

              ${moment.mood || moment.tags?.length > 0 ? `
                <div class="flex gap-2 ${isLeft ? 'justify-end' : ''}">
                  ${moment.mood ? `<span class="px-3 py-1 bg-primary-100 rounded-full text-sm">${moment.mood}</span>` : ''}
                  ${moment.tags?.map((tag: string) => `<span class="px-3 py-1 bg-primary-100 rounded-full text-sm">${tag}</span>`).join('') || ''}
                </div>
              ` : ''}

              <div class="flex gap-3 mt-4 ${isLeft ? 'justify-end' : ''}">
                <a href="/life/${moment.slug}" class="text-sm text-primary-400 hover:text-primary-300 transition-smooth">æŸ¥çœ‹è¯¦æƒ…</a>
                <a href="/life/${moment.slug}/edit" class="auth-only text-sm text-text-muted hover:text-primary-400 transition-smooth">âœï¸ ç¼–è¾‘</a>
                <button onclick="deleteMoment('${moment.id}', '${moment.title}')" class="auth-only text-sm text-text-muted hover:text-red-400 transition-smooth">ğŸ—‘ï¸ åˆ é™¤</button>
              </div>
            </div>
          </div>
          <div class="absolute left-4 md:left-1/2 w-4 h-4 bg-primary-300 rounded-full transform -translate-x-1/2 border-4 border-white shadow"></div>
          <div class="hidden md:block md:w-1/2"></div>
        </div>
      `;
    }

    // åŠ è½½å¹¶æ˜¾ç¤ºç¬é—´
    async function loadMoments(): Promise<void> {
      const loading = document.getElementById('loading');
      const emptyState = document.getElementById('empty-state');
      const timelineContainer = document.getElementById('timeline-container');
      const momentsList = document.getElementById('moments-list');

      if (!loading || !emptyState || !timelineContainer || !momentsList) return;

      try {
        const response = await fetch('/api/life');
        if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
        const moments = await response.json();

        loading.classList.add('hidden');

        if (!moments || moments.length === 0) {
          emptyState.classList.remove('hidden');
          timelineContainer.classList.add('hidden');
        } else {
          emptyState.classList.add('hidden');
          timelineContainer.classList.remove('hidden');
          momentsList.innerHTML = moments.map(renderMoment).join('');
        }
      } catch (error: any) {
        loading.innerHTML = `<p class="text-red-500">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadMoments();
    });
  </script>
</Layout>
