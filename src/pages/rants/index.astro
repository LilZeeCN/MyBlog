---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="åæ§½ - æˆ‘çš„æ¸©é¦¨åšå®¢">
  <div class="container mx-auto px-4 py-12">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <section class="text-center mb-12">
      <div class="text-6xl mb-4 animate-float">ğŸ’¢</div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">åæ§½åŒº</h1>
      <p class="text-xl text-text-secondary">é‡Šæ”¾æƒ…ç»ªï¼Œå…±é¸£å¿ƒå£°</p>
      <a href="/rants/new" class="auth-only inline-block mt-6 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-smooth font-medium">
        ğŸ’¢ å‘å¸ƒåæ§½
      </a>
    </section>

    <!-- åæ§½åˆ—è¡¨ -->
    <section id="rants-list" class="max-w-4xl mx-auto space-y-6">
      <div class="text-center py-12">
        <div class="animate-pulse">æ­£åœ¨åŠ è½½...</div>
      </div>
    </section>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ’¢</div>
      <p class="text-xl text-text-muted mb-6">è¿˜æ²¡æœ‰åæ§½ï¼Œå¼€å§‹å‘æ³„ç¬¬ä¸€ä¸ªå§</p>
      <a href="/rants/new" class="auth-only inline-block px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-smooth">
        å‘å¸ƒåæ§½
      </a>
    </div>
  </div>

  <script>
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // åŠ è½½å¹¶æ˜¾ç¤ºåæ§½
    async function loadRants(): Promise<void> {
      const container = document.getElementById('rants-list');
      const emptyState = document.getElementById('empty-state');

      if (!container || !emptyState) return;

      try {
        const response = await fetch('/api/rants');
        if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
        const rants = await response.json();

        container.innerHTML = '';

        if (!rants || rants.length === 0) {
          container.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        container.classList.remove('hidden');

        rants.forEach((rant: any, index: number) => {
          const angerLevel = rant.angerLevel || 5;
          let bgColor = 'bg-yellow-50/50';
          let emojiColor = 'bg-yellow-200';
          let emoji = 'ğŸ˜';
          let angerBg = 'bg-yellow-100 text-yellow-600';
          let hoverColor = 'hover:text-yellow-600';

          if (angerLevel >= 8) {
            bgColor = 'bg-red-50/50';
            emojiColor = 'bg-red-200';
            emoji = 'ğŸ¤¬';
            angerBg = 'bg-red-100 text-red-600';
            hoverColor = 'hover:text-red-500';
          } else if (angerLevel >= 5) {
            bgColor = 'bg-orange-50/50';
            emojiColor = 'bg-orange-200';
            emoji = 'ğŸ˜¤';
            angerBg = 'bg-orange-100 text-orange-600';
            hoverColor = 'hover:text-orange-500';
          }

          const div = document.createElement('div');
          div.className = 'relative animate-slide-up';
          div.style.animationDelay = `${index * 0.1}s`;

          div.innerHTML = `
            <div class="glass-effect rounded-2xl p-6 shadow-md hover:shadow-lg transition-smooth ${bgColor}">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full ${emojiColor} flex items-center justify-center text-2xl flex-shrink-0">
                  ${emoji}
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2 flex-wrap">
                    <a href="/rants/${rant.slug}" class="font-bold hover:text-primary-400 transition-smooth">${rant.title}</a>
                    <span class="px-2 py-1 ${angerBg} rounded text-xs font-bold">æ„¤æ€’æŒ‡æ•°: ${angerLevel}/10</span>
                  </div>
                  <p class="text-text-secondary mb-3">
                    ${rant.content}
                  </p>
                  <div class="flex items-center gap-4 text-sm text-text-muted mb-3">
                    <span>ğŸ“… ${formatDate(rant.createdAt)}</span>
                    ${rant.category ? `<span>ğŸ·ï¸ ${rant.category}</span>` : ''}
                    <span class="flex items-center gap-1 cursor-pointer ${hoverColor} transition-colors">
                      ğŸ‘Š å…±é¸£ <span class="font-bold">${rant.reactions || 0}</span>
                    </span>
                  </div>
                  <div class="flex gap-4">
                    <a href="/rants/${rant.slug}" class="text-primary-400 hover:text-primary-500 transition-smooth text-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                    <a href="/rants/${rant.slug}/edit" class="auth-only text-blue-500 hover:text-blue-600 transition-smooth text-sm">ç¼–è¾‘</a>
                    <button class="auth-only delete-btn text-red-500 hover:text-red-600 transition-smooth text-sm" data-id="${rant.id}">åˆ é™¤</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          container.appendChild(div);
        });

        // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).getAttribute('data-id')!;
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåæ§½å—ï¼Ÿ')) {
              try {
                const response = await fetch(`/api/rants/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
                loadRants();
              } catch (error: any) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
              }
            }
          });
        });
      } catch (error: any) {
        container.innerHTML = `<p class="text-red-500 text-center py-12">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadRants();
    });
  </script>
</Layout>
