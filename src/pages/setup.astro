---
import Layout from '../layouts/Layout.astro';
---

<Layout title="初始化示例数据 - 我的温馨博客">
  <div class="container mx-auto px-4 py-12 max-w-4xl">
    <section class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">🚀 初始化示例数据</h1>
      <p class="text-text-muted">为你的博客加载优秀的示例模板</p>
    </section>

    <div class="glass-effect rounded-2xl p-8 space-y-6">
      <!-- 状态显示 -->
      <div id="status-panel" class="hidden">
        <div class="p-4 rounded-lg mb-6" id="status-box">
          <p id="status-message" class="font-medium"></p>
        </div>
      </div>

      <!-- 示例数据预览 -->
      <div class="space-y-4">
        <h2 class="text-2xl font-bold mb-4">📦 包含的示例内容</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- 生活模块 -->
          <div class="border border-primary-200 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">🌱 生活瞬间 (3个)</h3>
            <ul class="text-sm text-text-muted space-y-1">
              <li>• 春日赏樱</li>
              <li>• 深夜编程的灵感</li>
              <li>• 学会做咖啡</li>
            </ul>
          </div>

          <!-- 哲学模块 -->
          <div class="border border-primary-200 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">🧠 哲学思考 (3个)</h3>
            <ul class="text-sm text-text-muted space-y-1">
              <li>• 存在先于本质 - 萨特</li>
              <li>• 认识你自己 - 苏格拉底</li>
              <li>• 西西弗斯的幸福 - 加缪</li>
            </ul>
          </div>

          <!-- 吐槽模块 -->
          <div class="border border-primary-200 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">💢 吐槽专区 (3个)</h3>
            <ul class="text-sm text-text-muted space-y-1">
              <li>• 毫无意义的会议</li>
              <li>• 看不懂的代码评审</li>
              <li>• 咖啡馆的慢网速</li>
            </ul>
          </div>

          <!-- 学习模块 -->
          <div class="border border-primary-200 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">📚 学习项目 (3个)</h3>
            <ul class="text-sm text-text-muted space-y-1">
              <li>• React 深度学习计划</li>
              <li>• TypeScript 类型体操</li>
              <li>• 系统设计与架构</li>
            </ul>
          </div>

          <!-- 项目模块 -->
          <div class="border border-primary-200 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">💻 代码项目 (3个)</h3>
            <ul class="text-sm text-text-muted space-y-1">
              <li>• AI 写作助手</li>
              <li>• 极简任务管理器</li>
              <li>• Aurora 设计系统</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="flex flex-col gap-4 mt-8">
        <button
          id="init-btn"
          class="auth-only w-full px-6 py-4 bg-primary-300 text-white rounded-lg hover:bg-primary-400 transition-smooth font-bold text-lg"
        >
          🎉 初始化示例数据
        </button>

        <button
          id="reset-btn"
          class="auth-only w-full px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-smooth font-medium"
        >
          🔄 清除示例数据并重新初始化
        </button>

        <a
          href="/"
          class="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-smooth font-medium text-center"
        >
          返回首页
        </a>
      </div>

      <!-- 提示信息 -->
      <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <h4 class="font-bold text-yellow-800 mb-2">⚠️ 注意事项</h4>
        <ul class="text-sm text-yellow-700 space-y-1">
          <li>• 需要管理员登录后才能初始化/重置示例数据</li>
          <li>• 初始化会写入 Supabase（同 slug 已存在会自动跳过，不覆盖）</li>
          <li>• 重置只会清除示例数据，不会影响你自己创建的内容</li>
          <li>• 删除示例数据后不可恢复，请谨慎操作</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', () => {
      const initBtn = document.getElementById('init-btn');
      const resetBtn = document.getElementById('reset-btn');
      const statusPanel = document.getElementById('status-panel');
      const statusBox = document.getElementById('status-box');
      const statusMessage = document.getElementById('status-message');

      function showStatus(message, isSuccess) {
        statusPanel.classList.remove('hidden');
        statusBox.className = `p-4 rounded-lg mb-6 ${
          isSuccess
            ? 'bg-green-50 border border-green-200'
            : 'bg-red-50 border border-red-200'
        }`;
        statusMessage.textContent = message;
        statusMessage.className = `font-medium ${
          isSuccess ? 'text-green-800' : 'text-red-800'
        }`;
      }

      // 初始化按钮
      initBtn.addEventListener('click', async () => {
        try {
          initBtn.disabled = true;
          initBtn.textContent = '初始化中...';

          const response = await fetch('/api/setup/examples', { method: 'POST' });
          const result = await response.json().catch(() => ({}));

          if (response.status === 401) {
            showStatus('🔐 请先登录管理员账号（即将跳转登录页）', false);
            setTimeout(() => {
              window.location.href = '/login';
            }, 800);
            return;
          }

          if (!response.ok || !result.success) {
            showStatus(`❌ ${result.error || '初始化失败'}`, false);
            return;
          }

          const modules = result.data || {};
          const totalInserted = Object.values(modules).reduce((sum, m) => sum + (m.inserted || 0), 0);
          const totalSkipped = Object.values(modules).reduce((sum, m) => sum + (m.skipped || 0), 0);

          showStatus(`✅ 初始化完成：新增 ${totalInserted} 条示例数据（跳过 ${totalSkipped} 条已存在）`, true);
          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        } catch (error: any) {
          showStatus(`❌ 初始化失败：${error.message || '未知错误'}`, false);
        } finally {
          initBtn.disabled = false;
          initBtn.textContent = '🎉 初始化示例数据';
        }
      });

      // 重置按钮
      resetBtn.addEventListener('click', async () => {
        if (!confirm('⚠️ 确定要清除“示例数据”并重新初始化吗？\n\n此操作只会删除示例数据（不会影响你自己创建的内容）。')) {
          return;
        }

        try {
          resetBtn.disabled = true;
          resetBtn.textContent = '清除中...';

          const deleteResponse = await fetch('/api/setup/examples', { method: 'DELETE' });
          const deleteResult = await deleteResponse.json().catch(() => ({}));

          if (deleteResponse.status === 401) {
            showStatus('🔐 请先登录管理员账号（即将跳转登录页）', false);
            setTimeout(() => {
              window.location.href = '/login';
            }, 800);
            return;
          }

          if (!deleteResponse.ok || !deleteResult.success) {
            showStatus(`❌ ${deleteResult.error || '清除失败'}`, false);
            return;
          }

          resetBtn.textContent = '重新初始化中...';
          const seedResponse = await fetch('/api/setup/examples', { method: 'POST' });
          const seedResult = await seedResponse.json().catch(() => ({}));

          if (!seedResponse.ok || !seedResult.success) {
            showStatus(`❌ ${seedResult.error || '重新初始化失败'}`, false);
            return;
          }

          const modules = seedResult.data || {};
          const totalInserted = Object.values(modules).reduce((sum, m) => sum + (m.inserted || 0), 0);
          showStatus(`✅ 重置完成：已重新写入 ${totalInserted} 条示例数据`, true);
          setTimeout(() => window.location.href = '/', 1500);
        } catch (error: any) {
          showStatus(`❌ 重置失败：${error.message || '未知错误'}`, false);
        } finally {
          resetBtn.disabled = false;
          resetBtn.textContent = '🔄 清除示例数据并重新初始化';
        }
      });
    });
  </script>
</Layout>
